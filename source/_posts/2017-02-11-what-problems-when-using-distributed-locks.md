title: 使用分布式锁时考虑哪些问题
date: 2017-02-11 18:38:33
categories: 分布式
tags: [分布式,锁,一致性,场景]
---
<img src="/img/distributed-locks.png"  width="300" class="img-topic" />
工作中经常解决对于稀缺资源争抢的问题，比如一定量库存的商品，如果多个用户同时购买，如果不对库存的扣减进行一定的保护，势必会造成超卖的问题。在交易系统中的退款就是这样情况，由于网络的延迟和重复提交极端情况下的时间差，造成重复的退款，从设计方面一定要避免以上情况的发生，需要对这样的资源和业务进行保护。
<!--more-->

这篇文章退款交易场景入手，引入分布式锁，包括以下内容：
- 锁的引入和局限性 
- 为什么引入分布式锁
- 使用分布式锁时注意考虑哪些问题
- 分布式锁的容错
- 终极奥义之无锁编程

## 锁的引入和局限性
锁是一种解决在争抢共享资源冲突的机制，通过互斥来防止多线程（或多进程）间造成的彼此干扰。锁的一个作用是一种获取保护资源的凭证，就像公园门票，只有持有门票才可以入园。另一个作用是将对同一类共享资源的并行访问串行化，没有获得锁只能排队等待，直到其他线程释放掉锁。这里需要对“同一类共享资源”正确理解，比如订单系统中的同一个商品库存，退款系统中同一个用户。

在多线程中，Java 已经提供了很好原生锁（包括synchronized，lock），前面的其他文章中也已经讲到了内置锁和显示锁的理解和使用，在此不再赘述。但是（是不是已经料到了我要说但是了呢？），在分布式系统中，因为要跨进程或者跨服务器 ，这种场景下JDK原生锁已经无法满足我们的需求，需要一种能够分布式系统中保护共享资源的方式，分布式锁在这种情况下产生了。

很多事情往往都是如此，为了解决一个问题，引入了新方案，而新方案却会带来其他的问题，又需要用更多的时间去解决新方案带来的问题。没有一个完美的方案，因此对方案的取舍，就是具体场景中应该重点关注哪些问题，忽略哪些问题的选择。

## 分布式锁的三要素
如何才称得上分布式锁呢？分布式锁需要满足三个基本的条件：
1. 允许跨主机访问
2. 全局唯一标识
3. 至少有两种状态，获取和释放


- 允许跨主机访问

顾名思义，分布式锁是在分布式部署环境中给多个主机提供锁服务，这已经超出了synchronized和lock的范畴。在多线程中，

- 允许跨主机访问

顾名思义，分布式锁是在分布式部署环境中给多个主机提供锁服务，这已经超出了synchronized和lock的范畴。在多线程中，